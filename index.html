<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Card√°pio Inteligente v41</title>
    <style>
        :root { --primary: #2e7d32; --bg: #f0f2f5; --text: #1a1a1a; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: var(--text); }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 15px; border-radius: 15px; min-height: 95vh; }
        .nav-tabs { display: flex; overflow-x: auto; gap: 8px; margin-bottom: 15px; background: #eee; padding: 8px; border-radius: 12px; scrollbar-width: none; }
        .tab { padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; border: none; background: #ddd; font-size: 11px; white-space: nowrap; flex-shrink: 0; }
        .tab.active { background: var(--primary); color: white; }
        .bloco { border-left: 5px solid var(--primary); background: #f8f9fa; padding: 12px; margin-bottom: 10px; border-radius: 8px; }
        h3 { margin: 0 0 5px 0; font-size: 10px; color: #666; text-transform: uppercase; }
        .btn-acao { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; margin: 5px 0; }
        .btn-save-mini { background: #444; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 10px; float: right; cursor: pointer; }
        .btn-sorteio-item { background: #fff; border: 1px solid var(--primary); color: var(--primary); padding: 2px 4px; border-radius: 4px; font-size: 9px; cursor: pointer; margin-left: 3px; }
        .edit-box { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 8px; margin: 5px 0; box-sizing: border-box; font-family: inherit; }
        .linha-ing { display: flex; gap: 5px; margin-bottom: 5px; }
        .qtd-f { width: 60px; text-align: center; }
        .ing-f { flex-grow: 1; }
        .check-item { display: flex; align-items: center; gap: 10px; padding: 12px; border-bottom: 1px solid #eee; }
        .table-wrap { overflow-x: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 1100px; font-size: 10px; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
    </style>
</head>
<body>
<div class="container">
    <div id="main-app">
        <div class="nav-tabs">
            <button class="tab active" onclick="app.mudarAba('dia', this)">Hoje</button>
            <button class="tab" onclick="app.mudarAba('tarefas', this)">Tarefas</button>
            <button class="tab" onclick="app.mudarAba('semana', this)">Semana</button>
            <button class="tab" onclick="app.mudarAba('despensa', this)">Despensa</button>
            <button class="tab" onclick="app.mudarAba('receitas', this)">Receitas</button>
            <button class="tab" onclick="app.mudarAba('notificacoes', this)">üîî Notif.</button>
            <button class="tab" onclick="app.mudarAba('pratos', this)">Base</button>
        </div>
        <div id="app-view"></div>
    </div>
</div>

<script>
const app = {
    abaAtual: 'dia',
    db: JSON.parse(localStorage.getItem('v41_db')) || {
        config_pratos: { cafe: "", beb_cafe: "", lanches: "", arroz: "", feijao: "", proteina: "", acompa: "", beb_almoco: "", jantares: "", beb_jantar: "" },
        receitas: {}, semana: {}, despensa: {}, ordem_receitas: [], ordem_despensa: [], checks_tarefas: {}, notificacoes: []
    },

    init() {
        this.sincronizarListas();
        this.render();
    },

    salvar() { localStorage.setItem('v41_db', JSON.stringify(this.db)); this.render(); },

    // Garante que novos itens entrem no topo e removidos saiam
    sincronizarListas() {
        let basePratos = [];
        Object.values(this.db.config_pratos).forEach(v => v.split('\n').forEach(p => { if(p.trim()) basePratos.push(p.trim()) }));
        
        // Receitas novas v√£o para o IN√çCIO
        basePratos.forEach(p => {
            if (!this.db.ordem_receitas.includes(p)) this.db.ordem_receitas.unshift(p);
        });
        this.db.ordem_receitas = this.db.ordem_receitas.filter(p => basePratos.includes(p));

        // Despensa: extrair ingredientes das receitas
        let baseIng = new Set();
        Object.values(this.db.receitas).forEach(r => r.ing?.forEach(i => { if(i.nome) baseIng.add(i.nome) }));
        baseIng.forEach(ing => {
            if (!this.db.ordem_despensa.includes(ing)) this.db.ordem_despensa.unshift(ing);
        });
        this.db.ordem_despensa = this.db.ordem_despensa.filter(ing => baseIng.has(ing));
    },

    podeFazer(nomePrato, estoqueRef = null) {
        const r = this.db.receitas[nomePrato.trim()];
        if (!r || !r.ing || r.ing.length === 0) return false; // REGRA ESTRITA: Sem receita/ingredientes = N√£o sorteia
        const est = estoqueRef || this.db.despensa;
        return r.ing.every(i => (est[i.nome] || 0) >= parseFloat(i.qtd) && (est[i.nome] > 0));
    },

    consumir(nomePrato, est) {
        const r = this.db.receitas[nomePrato.trim()];
        if (r && r.ing) r.ing.forEach(i => { if(est[i.nome] !== undefined) est[i.nome] -= parseFloat(i.qtd); });
    },

    sortearItem(campo, est = null) {
        const lista = (this.db.config_pratos[campo] || "").split('\n').filter(x => x.trim());
        const aptos = lista.filter(p => this.podeFazer(p, est));
        if (aptos.length > 0) {
            const esc = aptos[Math.floor(Math.random() * aptos.length)];
            if (est) this.consumir(esc, est);
            return esc;
        }
        return "Falta Estoque";
    },

    gerarSemana() {
        const simulado = { ...this.db.despensa };
        ["SEGUNDA","TER√áA","QUARTA","QUINTA","SEXTA","S√ÅBADO","DOMINGO"].forEach(d => {
            this.db.semana[d] = {
                cafe: this.sortearItem('cafe', simulado), bebC: this.sortearItem('beb_cafe', simulado),
                lM: this.sortearItem('lanches', simulado), arr: this.sortearItem('arroz', simulado), 
                fei: this.sortearItem('feijao', simulado), pro: this.sortearItem('proteina', simulado), 
                aco: this.sortearItem('acompa', simulado), bebA: this.sortearItem('beb_almoco', simulado),
                lT: this.sortearItem('lanches', simulado), jan: this.sortearItem('jantares', simulado), 
                bebJ: this.sortearItem('beb_jantar', simulado)
            };
        });
        this.salvar();
    },

    saveR(p) {
        const idBase = p.replace(/\s/g, '');
        const linhas = document.querySelectorAll(`.ing-row-${idBase}`);
        let novosIng = [];
        linhas.forEach(row => {
            const q = row.querySelector('.qtd-f').value;
            const n = row.querySelector('.ing-f').value.trim();
            if (n) novosIng.push({ qtd: q || 0, nome: n });
        });
        this.db.receitas[p] = { ing: novosIng, tarefas: document.getElementById(`tar-${p}`).value };
        
        // Move para o FINAL da lista de receitas
        this.db.ordem_receitas = [...this.db.ordem_receitas.filter(x => x !== p), p];
        this.sincronizarListas();
        this.salvar();
    },

    atualizarEstoque(ing, valor) {
        this.db.despensa[ing] = parseFloat(valor);
        // Move para o FINAL da lista da despensa
        this.db.ordem_despensa = [...this.db.ordem_despensa.filter(x => x !== ing), ing];
        this.salvar();
    },

    render() {
        const view = document.getElementById('app-view');
        const hoje = ["DOMINGO","SEGUNDA","TER√áA","QUARTA","QUINTA","SEXTA","S√ÅBADO"][new Date().getDay()];
        const d = this.db.semana[hoje] || {};

        if (this.abaAtual === 'dia') {
            view.innerHTML = `<h3>üç¥ Hoje (${hoje})</h3>
                <div class="bloco"><h3>‚òï Caf√©</h3>${d.cafe} + ${d.bebC}</div>
                <div class="bloco"><h3>üçõ Almo√ßo</h3>${d.arr}, ${d.fei}, ${d.pro}, ${d.aco} + ${d.bebA}</div>
                <div class="bloco"><h3>üåô Jantar</h3>${d.jan} + ${d.bebJ}</div>`;
        }
        else if (this.abaAtual === 'receitas') {
            let h = `<h2>üìñ Receitas</h2>`;
            this.db.ordem_receitas.forEach(p => {
                const r = this.db.receitas[p] || { ing: [], tarefas: "" };
                h += `<div class="bloco"><button class="btn-save-mini" onclick="app.saveR('${p}')">SALVAR</button><b>${p}</b>
                    <div id="ing-cont-${p}">`;
                (r.ing.length ? r.ing : [{qtd:'',nome:''}]).forEach(i => {
                    h += `<div class="linha-ing ing-row-${p.replace(/\s/g, '')}">
                        <input type="number" class="edit-box qtd-f" placeholder="Qtd" value="${i.qtd}">
                        <input type="text" class="edit-box ing-f" placeholder="Ingrediente" value="${i.nome}">
                    </div>`;
                });
                h += `</div><button class="btn-sorteio-item" onclick="app.addIngRow('${p}')">+ Ingrediente</button>
                    <textarea id="tar-${p}" class="edit-box" placeholder="Tarefas">${r.tarefas}</textarea></div>`;
            });
            view.innerHTML = h;
        }
        else if (this.abaAtual === 'despensa') {
            let h = `<h2>üì¶ Despensa</h2>`;
            this.db.ordem_despensa.forEach(ing => {
                h += `<div class="check-item" style="justify-content:space-between"><span>${ing}</span>
                    <input type="number" class="qtd-input" style="width:70px" value="${this.db.despensa[ing] || 0}" 
                    onchange="app.atualizarEstoque('${ing}', this.value)"></div>`;
            });
            view.innerHTML = h || "<p>Cadastre ingredientes nas receitas primeiro.</p>";
        }
        else if (this.abaAtual === 'semana') {
            let h = `<h2>üìÖ Semana</h2><button class="btn-acao" onclick="app.gerarSemana()">üîÑ Sorteio Inteligente</button>
                <div class="table-wrap"><table><tr><th>Ref.</th>`;
            const dias = ["SEGUNDA","TER√áA","QUARTA","QUINTA","SEXTA","S√ÅBADO","DOMINGO"];
            dias.forEach(n => h += `<th>${n}</th>`);
            h += `</tr>`;
            const rows = [{n:"Caf√©",k:"cafe"},{n:"Arroz",k:"arr"},{n:"Feij√£o",k:"fei"},{n:"Prot.",k:"pro"},{n:"Jantar",k:"jan"}];
            rows.forEach(r => {
                h += `<tr><td><b>${r.n}</b></td>`;
                dias.forEach(dia => h += `<td>${this.db.semana[dia]?.[r.k] || '-'} <button class="btn-sorteio-item" onclick="app.reSortear('${dia}','${r.k}')">üé≤</button></td>`);
                h += `</tr>`;
            });
            view.innerHTML = h + `</table></div>`;
        }
        else if (this.abaAtual === 'pratos') {
            let h = `<h2>‚öôÔ∏è Base</h2>`;
            Object.keys(this.db.config_pratos).forEach(k => {
                h += `<b>${k.toUpperCase()}:</b><textarea class="edit-box" onchange="app.db.config_pratos['${k}']=this.value;app.sincronizarListas();app.salvar()">${this.db.config_pratos[k]}</textarea>`;
            });
            view.innerHTML = h;
        }
    },

    reSortear(dia, k) {
        const mapa = {cafe:'cafe', arr:'arroz', fei:'feijao', pro:'proteina', jan:'jantares'};
        this.db.semana[dia][k] = this.sortearItem(mapa[k] || k);
        this.salvar();
    },

    addIngRow(p) {
        const container = document.getElementById(`ing-cont-${p}`);
        const div = document.createElement('div');
        div.className = `linha-ing ing-row-${p.replace(/\s/g, '')}`;
        div.innerHTML = `<input type="number" class="edit-box qtd-f" placeholder="Qtd"><input type="text" class="edit-box ing-f" placeholder="Ingrediente">`;
        container.appendChild(div);
    },

    mudarAba(aba, btn) {
        this.abaAtual = aba;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        this.render();
    }
};
app.init();
</script>
</body>
</html>

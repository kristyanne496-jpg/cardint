<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Card√°pio Inteligente</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <style>
        .table-wrapper { 
    width: 100%; 
    overflow-x: auto; /* Permite deslizar para o lado no celular */
    margin-top: 15px;
    border: 1px solid #ddd;
    border-radius: 10px;
}
table { 
    width: 100%; 
    border-collapse: collapse; 
    min-width: 900px; /* Garante que as colunas n√£o fiquem espremidas */
    background: white; 
}
th { 
    background: var(--primary); 
    color: white; 
    padding: 12px; 
    font-size: 0.85em; 
    text-transform: uppercase;
}
td { 
    padding: 10px; 
    border: 1px solid #eee; 
    vertical-align: top; 
    font-size: 0.8em; 
    line-height: 1.4; 
}
.ref-header { 
    background: #f1f1f1; 
    font-weight: bold; 
    color: var(--primary); 
    width: 100px; 
    position: sticky; 
    left: 0; /* Mant√©m o nome da refei√ß√£o vis√≠vel ao deslizar */
}
        /* Ajuste para as bebidas n√£o embolarem o texto */
td br {
    content: "";
    margin-bottom: 4px;
    display: block;
}
        
        .opcional { color: #d32f2f; font-size: 0.85em; display: block; margin-top: 5px; border-top: 1px dotted #ccc; padding-top: 2px; }
.sobremesa { color: #ff9800; font-weight: bold; display: block; margin-top: 8px; font-size: 0.9em; }
.aviso-fluxo { background: #e3f2fd; border: 1px solid #2196f3; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 0.85em; color: #0d47a1; }
        
        :root { --primary: #4CAF50; --bg: #f4f4f9; --text: #333; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 15px; color: var(--text); }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .shopping-list { list-style: none; padding: 0; }
.shopping-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #f9f9f9;
    margin-bottom: 8px;
    padding: 12px;
    border-radius: 8px;
    transition: 0.3s;
}
.shopping-item.checked {
    background: #e8f5e9;
    opacity: 0.6;
    text-decoration: line-through;
}
.shopping-item input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
}
.btn-limpar {
    background: #f44336;
    font-size: 12px;
    padding: 8px;
    margin-bottom: 15px;
}
        .semana-dia-box {
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
    background: #fff;
}
.semana-dia-box h2 {
    background: var(--primary);
    color: white;
    padding: 5px 15px;
    border-radius: 5px;
    font-size: 1.1em;
}
.detalhe-refeicao {
    margin-bottom: 8px;
    padding-bottom: 5px;
    border-bottom: 1px dashed #eee;
}
.detalhe-refeicao strong {
    color: #555;
    font-size: 0.9em;
}
.detalhe-refeicao p {
    margin: 2px 0 0 0;
    font-size: 0.95em;
}
        
        /* Navega√ß√£o */
        .nav-tabs { display: flex; gap: 8px; margin-bottom: 20px; background: #eee; padding: 5px; border-radius: 10px; }
        .tab { flex: 1; padding: 12px; text-align: center; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; font-size: 14px; }
        .tab.active { background: var(--primary); color: white; }

        /* Blocos de Refei√ß√£o */
        .bloco { border-left: 5px solid var(--primary); background: #f9f9f9; padding: 12px; margin-bottom: 12px; border-radius: 5px; }
        .bloco h3 { margin: 0 0 5px 0; font-size: 0.85em; color: #666; text-transform: uppercase; }
        .bloco p { margin: 0; font-size: 1.05em; font-weight: 500; }

        /* Tarefas e Compras */
        .tarefa-alerta { background: #fff3cd; border: 1px solid #ffeeba; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9em; }
        .shopping-list { list-style: none; padding: 0; }
        .shopping-list li { padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
        
        button { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .footer-info { text-align: center; font-size: 0.8em; color: #999; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div id="app-nav" class="nav-tabs">
        <div class="tab active" onclick="app.mudarAba('dia')">Hoje</div>
        <div class="tab" onclick="app.mudarAba('semana')">Semana</div>
        <div class="tab" onclick="app.mudarAba('compras')">Compras</div>
    </div>

    <div id="conteudo-principal">
        </div>

    <div class="footer-info" id="status-plano"></div>
</div>

<script>
const app = {
    config: { feijaoDias: 4, proteinasRepetirMax: 2, totalSemanas: 12 },
    https://www.templatemaker.nl/pt/
    banco: {
        cafe: {
            bases: ["P√£o franc√™s","P√£o de forma","P√£o caseiro","Tapioca","Cuscuz","Bolo simples caseiro","Panqueca","Crepioca","Mingau de aveia","Mingau de milho","P√£o de queijo","Torrada","Aipim cozido","Banana da terra cozida","Batata doce cozida","Iogurte com frutas","Mingau de tapioca","Mingau de milho"],
            acompanhamentos: ["Manteiga ou Margarina","Requeij√£o","Cream cheese","Catupiry","Queijo mussarela","Ovo mexido","Ovo cozido","Pat√™ de frango caseiro","Pat√™ de atum caseiro","Presunto","Mortadela","Peito de peru","Presunto",],
            bebidas: ["Caf√©","Leite com achocolatado","Ch√°","Vitamina","Ch√° gelado","Suco de uva integral","Suco"]
                // Substitua as listas antigas por estas:
bebidaPadaria: ["Caf√© preto","Leite com achocolatado","Ch√° gelado","Ch√°"], 
sucos: ["Maracuj√°","Laranja","Abacaxi","Lim√£o","Cupua√ßu","Cacau","Graviola","Manga","Melancia"],
sobremesas: ["Gelatina", "Sorvete", "Pudim", "Mousse de maracuj√°", "Mousse de lim√£o"],
    
        },
        almoco: {
            feijoes: ["Feij√£o carioca","Feij√£o preto","Feij√£o fradinho"],
            proteinas: ["Frango cozido","Frango frito","Frango assado","Frango desfiado","Carne mo√≠da","Carne do sol","Carne de panela","Bife no molho","Alm√¥ndega","Peixe frito","Steak de frango","Iscas de frango","F√≠gado Acebolado","Moqueca","Ovo mexido","Panqueca de carne","Lingui√ßa","Panqueca de frango","Salsicha"],
            acompanhamentos: ["Macarr√£o","Pur√™ de ab√≥bora","Pur√™ de batata,"Pur√™ de aipim","Batata cozida","Mandioca frita","Batata frita","Salada de Maionese","Salada de Alface com tomate","Salada de couve com tomate","Vinagrete","Couve refogada","Creme de milho","Farofa pronta","Farofa de banana da terra","Farofa de cebola","Farofa de cenoura"],
            especial: "Feijoada Completa"
        },
        jantar: {
            opcoes: ["Arroz com ovo","Arroz com frango","Macarr√£o com frango","Sopa","Caldo de carne","Caldo de frango","Caldo de calabresa","Mini Salgados","Cachorro quente","Pizza","Hamb√∫rguer","Arroz doce","P√£o franc√™s","P√£o de forma","P√£o caseiro","Tapioca","Cuscuz com ovo","Cuscuz com banana da terra","Cuscuz com carne do sol","Farofa de cuscuz","Bolo simples caseiro","Panqueca de frango","Panqueca de carne","Crepioca","Mingau de aveia","Mingau de milho","P√£o de queijo","Torrada com pat√™","Aipim cozido","Banana da terra cozida","Batata doce cozida","Mingau de tapioca","Mingau de milho"],
        },
        lanches: {
            frutas: ["Banana","Ma√ß√£","Uva","Abacaxi","Pera","Manga","Melancia","Ma√ß√£ Verde","Tangerina","Morango","Laranja","Ameixa"],
            tarde: ["Biscoito","Iogurte com frutas","Iogurte com granola","Bolo caseiro","Vitamina de a√ßa√≠","Vitamina de frutas","Sonho de padaria","Salada de frutas"]
        }
    },

    // --- L√ìGICA DE GERA√á√ÉO ---
    escolher(lista) { return lista[Math.floor(Math.random() * lista.length)]; },

    gerarPlanoCompleto() {
        let plano = [];
        for (let s = 0; s < this.config.totalSemanas; s++) {
            plano.push(this.gerarSemana());
        }
        localStorage.setItem("plano", JSON.stringify(plano));
        localStorage.setItem("diaAtual", "0");
        localStorage.setItem("ultimaVisita", new Date().toDateString());
    },

    gerarSemana() {
        const diasNome = ["Segunda","Ter√ßa","Quarta","Quinta","Sexta","S√°bado","Domingo"];
        let semana = {};
        let feijaoAtual = this.escolher(this.banco.almoco.feijoes);
        let protUltima = ""; let protCont = 0;

        diasNome.forEach((dia, index) => {
            // Localize onde o 'semana[d]' √© montado e use esta l√≥gica:
const baseCafe = this.escolher(this.banco.cafe);
const isMingau = baseCafe.toLowerCase().includes("mingau");
const prot = this.escolher(this.banco.proteina);

semana[d] = {
    cafe: {
        txt: isMingau ? baseCafe : `${baseCafe} com ${this.escolher(this.banco.acompa)}<br>‚Ä¢ ${this.escolher(this.banco.bebidaPadaria)}`,
        obs: isMingau ? "<span class='opcional'>Op√ß√£o 2: P√£o com Caf√©</span>" : ""
    },
    lancheM: this.escolher(this.banco.lanches),
    almoco: {
        txt: `Arroz e Feij√£o<br>‚Ä¢ ${prot}<br>‚Ä¢ ${this.escolher(this.banco.acompaAlmoco)}<br>‚Ä¢ Suco de ${this.escolher(this.banco.sucos)}`,
        obs: prot.includes("F√≠gado") ? "<span class='opcional'>Op√ß√£o 2: Frango Grelhado</span>" : "",
        sobremesa: (d === "S√ÅBADO" || d === "DOMINGO") ? `<span class='sobremesa'>üçÆ ${this.escolher(this.banco.sobremesas)}</span>` : ""
    },
    lancheT: `${this.escolher(["Biscoito", "Bolo", "Torradas"])} com ${this.escolher(["Ch√°", "Leite com achocolatado"])}`,
    jantar: `${this.escolher(this.banco.jantar)}<br>‚Ä¢ Suco de ${this.escolher(this.banco.sucos)}`
};
            // No bloco do Almo√ßo:
almoco: {
    txt: `Arroz e Feij√£o<br>‚Ä¢ ${prot}<br>‚Ä¢ ${this.escolher(this.banco.acompaAlmoco)}<br>‚Ä¢ ü•§ Suco de ${this.escolher(this.banco.sucos)}`,
    obs: prot.includes("F√≠gado") ? "<span class='opcional'>Op√ß√£o 2: Frango Grelhado</span>" : "",
    sobremesa: (d === "S√ÅBADO" || d === "DOMINGO") ? `<span class='sobremesa'>üçÆ ${this.escolher(this.banco.sobremesas)}</span>` : ""
},

// No bloco do Jantar:
jantar: `${this.escolher(this.banco.jantar)}<br>‚Ä¢ ü•§ Suco de ${this.escolher(this.banco.sucos)}`
    
    
            // Troca feij√£o a cada 4 dias
            if (index === 4) feijaoAtual = this.escolher(this.banco.almoco.feijoes);

            // Regra de Prote√≠na
            let prot;
            do { prot = this.escolher(this.banco.almoco.proteinas); } 
            while (prot === protUltima && protCont >= this.config.proteinasRepetirMax - 1);
            
            protCont = (prot === protUltima) ? protCont + 1 : 0;
            protUltima = prot;

            // Feijoada no S√°bado (50% chance)
            let almocoFinal = { arroz: "Arroz", feijao: feijaoAtual, proteina: prot, acompanhamento: this.escolher(this.banco.almoco.acompanhamentos) };
            if (dia === "S√°bado" && Math.random() > 0.5) {
                almocoFinal.feijao = "Caldo de Feijoada";
                almocoFinal.proteina = this.banco.almoco.especial;
            }

            semana[dia] = {
                cafe: { base: this.escolher(this.banco.cafe.bases), acompanhamento: this.escolher(this.banco.cafe.acompanhamentos), bebida: this.escolher(this.banco.cafe.bebidas) },
                lancheManha: this.escolher(this.banco.lanches.frutas),
                almoco: almocoFinal,
                lancheTarde: this.escolher(this.banco.lanches.tarde),
                jantar: this.escolher(this.banco.jantar.opcoes)
            };
        });
        return semana;
    },

    // --- CONTROLE DE FLUXO ---
    iniciar() {
        if (!localStorage.getItem("plano")) this.gerarPlanoCompleto();
        this.verificarViradaDeDia();
        this.mudarAba('dia');
        this.agendarNotificacoes();
    },

    verificarViradaDeDia() {
        const hoje = new Date().toDateString();
        const ultima = localStorage.getItem("ultimaVisita");
        if (ultima !== hoje) {
            let dia = parseInt(localStorage.getItem("diaAtual"));
            dia++;
            if (dia >= (this.config.totalSemanas * 7)) {
                this.gerarPlanoCompleto();
            } else {
                localStorage.setItem("diaAtual", dia);
                localStorage.setItem("ultimaVisita", hoje);
            }
        }
    },

        obterDados() {
        let plano = JSON.parse(localStorage.getItem("plano"));
        if (!plano) plano = this.gerarTudo();
        
        // Pega a data real do sistema
        const dataHoje = new Date();
        const diaSemanaReal = dataHoje.getDay(); // 0=Dom, 1=Seg, 2=Ter...
        
        // Ajusta o √≠ndice para Segunda ser o primeiro dia (√≠ndice 0)
        // No JS: Dom=0, Seg=1... No seu plano: Seg=0, Ter=1...
        let diaIdxCorrigido = diaSemanaReal === 0 ? 6 : diaSemanaReal - 1;
        
        // Recupera em qual semana do plano de 12 semanas voc√™ est√°
        let semanaAtualIdx = parseInt(localStorage.getItem("semanaPlanoIdx") || "0");
        
        return { 
            semana: plano[semanaAtualIdx], 
            diaIdx: diaIdxCorrigido 
        };
    },
,

    // --- INTERFACE ---
    mudarAba(aba) {
        const abas = document.querySelectorAll('.tab');
        abas.forEach(t => t.classList.remove('active'));
        event?.target?.classList?.add('active') || abas[0].classList.add('active');

        const container = document.getElementById("conteudo-principal");
        const info = this.obterDadosHoje();
        
        if (aba === 'dia') {
            // Adicione esta linha logo antes do container.innerHTML:
const avisoPreparo = `
    <div class="aviso-fluxo">
        üì¢ <strong>Organiza√ß√£o:</strong> Prepare agora o lanche da tarde (${d.lancheT}) 
        e verifique os ingredientes do jantar.
    </div>`;

// E no innerHTML, chame a vari√°vel:
container.innerHTML = avisoPreparo + `... resto do seu c√≥digo ...`;


    renderDia(el, info) {
        const d = info.dados;
        let tarefasHtml = "";
        
        // L√≥gica de Tarefas Autom√°ticas
        if (d.almoco.feijao.includes("Feij√£o")) tarefasHtml += `<div class="tarefa-alerta">üîî <strong>Tarefa:</strong> Deixar feij√£o de molho agora para cozinhar.</div>`;
        if (d.cafe.base === "Cuscuz") tarefasHtml += `<div class="tarefa-alerta">ü•£ <strong>Tarefa:</strong> Hidratar o cuscuz 15min antes.</div>`;

        el.innerHTML = `
            <h2>${info.nome}-feira</h2>
            ${tarefasHtml}
            <div class="bloco"><h3>‚òï Caf√© da Manh√£</h3><p>${d.cafe.base} com ${d.cafe.acompanhamento} e ${d.cafe.bebida}</p></div>
            <div class="bloco"><h3>üçé Lanche</h3><p>${d.lancheManha}</p></div>
            <div class="bloco"><h3>üçõ Almo√ßo</h3><p>${d.almoco.arroz}, ${d.almoco.feijao}, ${d.almoco.proteina} e ${d.almoco.acompanhamento}</p></div>
            <div class="bloco"><h3>üç™ Tarde</h3><p>${d.lancheTarde}</p></div>
            <div class="bloco"><h3>üåô Jantar</h3><p>${d.jantar}</p></div>
            <button onclick="app.concluirDiaManual()">Concluir Dia e Avan√ßar</button>
        `;
    },

        renderSemana(el) {
        renderTabela(container, semana) {
    const dias = ["SEGUNDA", "TER√áA", "QUARTA", "QUINTA", "SEXTA", "S√ÅBADO", "DOMINGO"];
    const refeicoes = [
        { label: "‚òï Caf√©", key: "cafe" },
        { label: "üçé Lanche M.", key: "lancheM" },
        { label: "üçõ Almo√ßo", key: "almoco" },
        { label: "üç™ Lanche T.", key: "lancheT" },
        { label: "üåô Jantar", key: "jantar" }
    ];

    let html = `<h2>Card√°pio Semanal</h2><div class="table-wrapper"><table>`;
    
    // Cabe√ßalho com os Dias
    html += `<thead><tr><th class="ref-header">Refei√ß√£o</th>`;
    dias.forEach(dia => html += `<th>${dia}</th>`);
    html += `</tr></thead><tbody>`;

    // Linhas com as Refei√ß√µes
    refeicoes.forEach(ref => {
        html += `<tr><td class="ref-header">${ref.label}</td>`;
        dias.forEach(dia => {
            let info = semana[dia][ref.key];
            // Trata se o dado √© um objeto (como almoco) ou string
            let textoRef = "";
            if (typeof info === 'string') {
                textoRef = info;
            } else if (ref.key === 'cafe') {
                textoRef = `${info.txt}<br>${info.obs}`;
            } else if (ref.key === 'almoco') {
                textoRef = `${info.txt}<br>${info.obs}<br>${info.sobremesa}`;
            } else if (ref.key === 'jantar') {
                textoRef = info; // ou info.prato se for objeto
            }
            
            html += `<td>${textoRef}</td>`;
        });
        html += `</tr>`;
    });

    html += `</tbody></table></div>`;
    html += `<p style="font-size:0.7em; color:#666; margin-top:10px">‚Üê Deslize para o lado para ver todos os dias ‚Üí</p>`;
    
    container.innerHTML = html;
}
        el.innerHTML = html;
        window.scrollTo(0,0); // Volta para o topo ao abrir
    },


        renderCompras(el) {
        const { semana } = this.obterDados();
        const itensSet = new Set();
        
        // Coleta todos os itens base da semana
        Object.values(semana).forEach(d => {
            // Extrai as palavras principais para a lista
            const extrator = (str) => str.split('<br>')[0].split(' com ')[0].replace('‚Ä¢ ', '');
            itensSet.add(extrator(d.cafe));
            itensSet.add(d.lancheM);
            itensSet.add("Arroz branco");
            itensSet.add(extrator(d.almoco.split('<br>‚Ä¢ ')[1])); // Feij√£o
            itensSet.add(extrator(d.almoco.split('<br>‚Ä¢ ')[2])); // Prote√≠na
        });

        const estoque = JSON.parse(localStorage.getItem("estoque") || "[]");
        
        let html = `<h2>üõí Estoque e Compras</h2>
                    <p style="font-size:0.8em; color:#666">Marque o que voc√™ j√° tem em casa:</p>
                    <button class="btn-limpar" onclick="app.limparEstoque()">Limpar Sele√ß√£o</button>
                    <ul class="shopping-list">`;

        Array.from(itensSet).sort().forEach(item => {
            const isChecked = estoque.includes(item) ? "checked" : "";
            const isCheckedAttr = estoque.includes(item) ? "checked" : "";
            
            html += `
                <li class="shopping-item ${isChecked}">
                    <span>${item}</span>
                    <input type="checkbox" ${isCheckedAttr} onchange="app.toggleEstoque('${item}')">
                </li>`;
        });

        el.innerHTML = html + `</ul>`;
    },

    toggleEstoque(item) {
        let estoque = JSON.parse(localStorage.getItem("estoque") || "[]");
        if (estoque.includes(item)) {
            estoque = estoque.filter(i => i !== item);
        } else {
            estoque.push(item);
        }
        localStorage.setItem("estoque", JSON.stringify(estoque));
        this.mudarAba('compras'); // Recarrega a tela para aplicar o estilo visual
    },

    limparEstoque() {
        if(confirm("Deseja desmarcar todos os itens?")) {
            localStorage.setItem("estoque", "[]");
            this.mudarAba('compras');
        }
    }

            proximo() {
        const mensagem = "‚úÖ Tarefas do dia conclu√≠das!\n\nüîî NOTIFICA√á√ÉO: Lembre-se de preparar o Caf√© da Manh√£ de AMANH√É agora √† noite!";
        alert(mensagem);
        // N√£o precisamos mais somar +1 no diaIdx, pois o Date() far√° isso amanh√£.
    },


    // --- NOTIFICA√á√ïES ---
    agendarNotificacoes() {
        if (!("Notification" in window)) return;
        Notification.requestPermission();
        
        const info = this.obterDadosHoje().dados;
        const agendamentos = [
            { h: 7, m: 0, t: "Caf√© da Manh√£", c: info.cafe.base },
            { h: 12, m: 0, t: "Almo√ßo", c: info.almoco.proteina },
            { h: 18, m: 30, t: "Jantar", c: info.jantar }
        ];

        agendamentos.forEach(a => {
            const agora = new Date();
            const alvo = new Date();
            alvo.setHours(a.h, a.m, 0);
            if (alvo > agora) {
                setTimeout(() => {
                    new Notification(a.t, { body: `Hoje teremos: ${a.c}` });
                }, alvo - agora);
            }
        });
    }
};

// Registro de Service Worker para PWA
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(() => console.log("SW offline mode ready"));
}

app.iniciar();
        verificarViradaSemana() {
        const hoje = new Date();
        const dataUltimoAcesso = localStorage.getItem("ultimaDataAcesso");
        
        if (dataUltimoAcesso) {
            const ultima = new Date(dataUltimoAcesso);
            // Se hoje for segunda e o √∫ltimo acesso n√£o foi hoje
            if (hoje.getDay() === 1 && ultima.toDateString() !== hoje.toDateString()) {
                let semIdx = parseInt(localStorage.getItem("semanaPlanoIdx") || "0");
                semIdx = (semIdx + 1) % 12; // Avan√ßa a semana (at√© 12 e volta pro 0)
                localStorage.setItem("semanaPlanoIdx", semIdx);
            }
        }
        localStorage.setItem("ultimaDataAcesso", hoje.toISOString());
    },

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Card√°pio Inteligente v32</title>
    <style>
        :root { --primary: #2e7d32; --bg: #f0f2f5; --text: #1a1a1a; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: env(safe-area-inset-top) 10px 10px 10px; color: var(--text); }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 15px; border-radius: 15px; min-height: 95vh; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .nav-tabs { display: flex; overflow-x: auto; gap: 8px; margin-bottom: 15px; background: #eee; padding: 8px; border-radius: 12px; scrollbar-width: none; }
        .nav-tabs::-webkit-scrollbar { display: none; }
        .tab { padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; border: none; background: #ddd; font-size: 11px; white-space: nowrap; flex-shrink: 0; }
        .tab.active { background: var(--primary); color: white; }
        .bloco { border-left: 5px solid var(--primary); background: #f8f9fa; padding: 12px; margin-bottom: 10px; border-radius: 8px; }
        h3 { margin: 0 0 5px 0; font-size: 10px; color: #666; text-transform: uppercase; }
        .btn-acao { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; margin: 5px 0; }
        .btn-danger { background: #d32f2f; color: white; border: none; padding: 10px; border-radius: 8px; width: 100%; cursor: pointer; margin-bottom: 15px; font-weight: bold; }
        .btn-save-mini { background: #444; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 10px; float: right; cursor: pointer; }
        .btn-sorteio-mini { background: #fff; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-size: 10px; padding: 2px 4px; margin-left: 4px; }
        .edit-box { width: 100%; min-height: 45px; padding: 8px; border: 1px solid #ccc; border-radius: 8px; margin: 5px 0; box-sizing: border-box; }
        .check-item { display: flex; align-items: center; gap: 10px; padding: 12px; border-bottom: 1px solid #eee; }
        .table-wrap { width: 100%; overflow-x: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; font-size: 10px; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
        .login-box { text-align: center; padding: 40px 20px; }
    </style>
</head>
<body>
<div class="container">
    <div id="login-screen" style="display:none;" class="login-box">
        <h2>üîê Acessar Card√°pio</h2>
        <input type="email" id="user-email" class="edit-box" placeholder="seu@email.com" style="text-align:center">
        <button class="btn-acao" onclick="app.login()">Entrar / Sincronizar</button>
    </div>

    <div id="main-app" style="display:none;">
        <div class="nav-tabs">
            <button class="tab active" onclick="app.mudarAba('dia', this)">Hoje</button>
            <button class="tab" onclick="app.mudarAba('tarefas', this)">Tarefas</button>
            <button class="tab" onclick="app.mudarAba('semana', this)">Semana</button>
            <button class="tab" onclick="app.mudarAba('despensa', this)">Despensa</button>
            <button class="tab" onclick="app.mudarAba('receitas', this)">Receitas</button>
            <button class="tab" onclick="app.mudarAba('pratos', this)">Base</button>
            <button class="tab" onclick="app.logout()" style="background:#ffcdd2">Sair</button>
        </div>
        <div id="app-view"></div>
    </div>
</div>

<script>
const app = {
    abaAtual: 'dia',
    user: localStorage.getItem('cardapio_user'),
    db: JSON.parse(localStorage.getItem('v32_db')) || {
        config_pratos: { cafe: "", bebidas: "", arroz: "", feijao: "", proteina: "", acompa: "", lanches: "", jantares: "" },
        receitas: {}, semana: {}, checks_tarefas: {}, checks_despensa: [], ordem_receitas: []
    },

    init() {
        if (!this.user) document.getElementById('login-screen').style.display = 'block';
        else {
            document.getElementById('main-app').style.display = 'block';
            this.render();
        }
    },

    login() {
        const e = document.getElementById('user-email').value;
        if (e.includes('@')) { localStorage.setItem('cardapio_user', e); location.reload(); }
    },

    logout() { localStorage.removeItem('cardapio_user'); location.reload(); },

    salvar() { localStorage.setItem('v32_db', JSON.stringify(this.db)); this.render(); },

    limpar(t) { return t ? t.trim() : ""; },

    // REGRA REFOR√áADA: S√≥ retorna verdadeiro se a receita existir E tiver todos os ingredientes marcados
    temTudo(nome) {
        const n = this.limpar(nome);
        const r = this.db.receitas[n];
        // Se n√£o houver receita ou lista de ingredientes, o prato n√£o participa do sorteio
        if (!r || !r.ing || r.ing.trim() === "") return false;
        
        const necessarios = r.ing.split('\n').map(i => this.limpar(i)).filter(x => x);
        if (necessarios.length === 0) return false;

        return necessarios.every(ing => (this.db.checks_despensa || []).includes(ing));
    },

    sortearInteligente(campo) {
        const lista = (this.db.config_pratos[campo] || "").split('\n').filter(x => x.trim());
        const aptos = lista.filter(p => this.temTudo(p));
        return aptos.length > 0 ? aptos[Math.floor(Math.random() * aptos.length)] : "Vazio";
    },

    gerarSemanaCompleta() {
        ["SEGUNDA","TER√áA","QUARTA","QUINTA","SEXTA","S√ÅBADO","DOMINGO"].forEach(d => {
            this.db.semana[d] = {
                cafe: this.sortearInteligente('cafe'), bebC: this.sortearInteligente('bebidas'),
                lM: this.sortearInteligente('lanches'), arr: this.sortearInteligente('arroz'), 
                fei: this.sortearInteligente('feijao'), pro: this.sortearInteligente('proteina'), 
                aco: this.sortearInteligente('acompa'), bebA: this.sortearInteligente('bebidas'),
                lT: this.sortearInteligente('lanches'), jan: this.sortearInteligente('jantares'), 
                bebJ: this.sortearInteligente('bebidas')
            };
        });
        this.salvar();
    },

    render() {
        const view = document.getElementById('app-view');
        const hoje = ["DOMINGO","SEGUNDA","TER√áA","QUARTA","QUINTA","SEXTA","S√ÅBADO"][new Date().getDay()];
        const d = this.db.semana[hoje] || {};

        if (this.abaAtual === 'dia') {
            view.innerHTML = `<h3>üç¥ Hoje (${hoje})</h3>
                <div class="bloco"><h3>‚òï Caf√©</h3>${d.cafe || 'Vazio'} + ${d.bebC || ''}</div>
                <div class="bloco"><h3>üçé Lanches</h3>M: ${d.lM || 'Vazio'} / T: ${d.lT || 'Vazio'}</div>
                <div class="bloco"><h3>üçõ Almo√ßo</h3>${d.arr || ''}, ${d.fei || ''}, ${d.pro || ''}, ${d.aco || ''}</div>
                <div class="bloco"><h3>üåô Jantar</h3>${d.jan || 'Vazio'}</div>`;
        }
        else if (this.abaAtual === 'semana') {
            let h = `<h2>üìÖ Semana</h2><button class="btn-acao" onclick="app.gerarSemanaCompleta()">üîÑ Sortear com base na Despensa</button><div class="table-wrap"><table><tr><th>Refei√ß√£o</th>`;
            const dias = ["SEGUNDA","TER√áA","QUARTA","QUINTA","SEXTA","S√ÅBADO","DOMINGO"];
            dias.forEach(n => h += `<th>${n}</th>`);
            h += `</tr>`;
            const rows = [
                {n:"Caf√©",k:"cafe"}, {n:"Lanche M.",k:"lM"}, {n:"Arroz",k:"arr"}, {n:"Feij√£o",k:"fei"}, 
                {n:"Prot.",k:"pro"}, {n:"Acomp.",k:"aco"}, {n:"Lanche T.",k:"lT"}, {n:"Jantar",k:"jan"}
            ];
            rows.forEach(r => {
                h += `<tr><td><b>${r.n}</b></td>`;
                dias.forEach(dia => h += `<td>${this.db.semana[dia]?.[r.k] || 'Vazio'}</td>`);
                h += `</tr>`;
            });
            view.innerHTML = h + `</table></div>`;
        }
        else if (this.abaAtual === 'despensa') {
            let h = `<h2>üì¶ Despensa</h2><button class="btn-danger" onclick="if(confirm('Limpar tudo?')){app.db.checks_despensa=[];app.salvar()}">üóëÔ∏è Esvaziar Despensa</button>`;
            let ings = new Set();
            Object.values(this.db.receitas).forEach(r => { if(r.ing) r.ing.split('\n').forEach(i => { if(i.trim()) ings.add(i.trim()) })});
            Array.from(ings).sort().forEach(ing => {
                const c = (this.db.checks_despensa || []).includes(ing);
                h += `<div class="check-item"><input type="checkbox" ${c?'checked':''} onchange="app.toggleD('${ing}', this)"> ${ing}</div>`;
            });
            view.innerHTML = h || "<p>Cadastre ingredientes nas receitas.</p>";
        }
        else if (this.abaAtual === 'receitas') {
            let h = `<h2>üìñ Receitas</h2>`;
            let base = new Set();
            Object.values(this.db.config_pratos).forEach(v => v.split('\n').forEach(p => { if(p.trim()) base.add(p.trim()) }));
            let lista = [...new Set([...this.db.ordem_receitas, ...Array.from(base)])];
            lista.forEach(p => {
                const r = this.db.receitas[p] || { ing: "", tarefas: "" };
                h += `<div class="bloco"><button class="btn-save-mini" onclick="app.saveR('${p}')">SALVAR</button><b>${p}</b><br>
                    <textarea id="ing-${p}" class="edit-box" placeholder="Ingredientes">${r.ing}</textarea>
                    <textarea id="tar-${p}" class="edit-box" placeholder="Tarefas">${r.tarefas}</textarea></div>`;
            });
            view.innerHTML = h;
        }
        else if (this.abaAtual === 'pratos') {
            let h = `<h2>‚öôÔ∏è Base</h2>`;
            Object.keys(this.db.config_pratos).forEach(k => {
                h += `<b>${k.toUpperCase()}:</b><textarea class="edit-box" onchange="app.db.config_pratos['${k}']=this.value;app.salvar()">${this.db.config_pratos[k]}</textarea>`;
            });
            view.innerHTML = h;
        }
    },

    saveR(p) {
        this.db.receitas[p] = { ing: document.getElementById(`ing-${p}`).value, tarefas: document.getElementById(`tar-${p}`).value };
        this.db.ordem_receitas = [p, ...this.db.ordem_receitas.filter(x => x !== p)];
        this.salvar();
        alert('Salvo em card√°pio inteligente');
    },

    toggleD(ing, el) {
        if(el.checked) this.db.checks_despensa.push(ing);
        else this.db.checks_despensa = this.db.checks_despensa.filter(x => x !== ing);
        this.salvar();
    },

    mudarAba(aba, btn) {
        this.abaAtual = aba;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        this.render();
    }
};
app.init();
</script>
</body>
</html>

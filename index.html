<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2e7d32">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1048/1048953.png">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIk1ldSBDYXJkw6FwaW8iLAogICJzaG9ydF9uYW1lIjogIkNhcmTDoXBpbyIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZmZmZmZmIiwKICAidGhlbWVfY29sb3IiOiAiIzJlN2QzMiIsCiAgImljb25zIjogW3sKICAgICJzcmMiOiAiaHR0cHM6Ly9jZG4taWNvbnMtcG5nLmZsYXRpY29uLmNvbS81MTIvMTA0OC8xMDQ4OTUzLnBuZyIsCiAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgfV0KfQ==">

    <title>Card√°pio Inteligente</title>
    <style>
        :root { --primary: #2e7d32; --bg: #f0f2f5; --text: #1a1a1a; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: env(safe-area-inset-top) 10px 10px 10px; color: var(--text); }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); min-height: 92vh; }
        
        #painel-alarme { display: none; background: #d32f2f; color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; border: 4px solid #b71c1c; animation: flash 1s infinite; }
        @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        
        .nav-tabs { display: flex; gap: 5px; margin-bottom: 20px; background: #e0e0e0; padding: 5px; border-radius: 12px; overflow-x: auto; }
        .tab { flex: 1; padding: 12px 8px; text-align: center; border-radius: 8px; cursor: pointer; font-weight: bold; border: none; background: transparent; font-size: 11px; white-space: nowrap; }
        .tab.active { background: var(--primary); color: white; }
        
        .bloco { border-left: 6px solid var(--primary); background: #f8f9fa; padding: 18px; margin-bottom: 15px; border-radius: 8px; }
        h3 { margin: 0 0 8px 0; font-size: 11px; color: #555; text-transform: uppercase; }
        
        .table-wrap { width: 100%; overflow-x: auto; border-radius: 10px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: left; vertical-align: top; font-size: 11px; }
        .hoje-row { background: #e8f5e9 !important; border: 2px solid var(--primary) !important; }
        
        .btn-reroll { cursor: pointer; background: #fff; border: 1px solid #ccc; border-radius: 4px; padding: 2px 5px; font-size: 14px; float: right; }
        .btn-config { background: #1a1a1a; color: white; border: none; padding: 15px; border-radius: 10px; width: 100%; margin-bottom: 15px; font-weight: bold; font-size: 13px; }
        .edit-box { width: 100%; min-height: 80px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-family: inherit; }
        .segunda-opcao { font-size: 10px; color: #e65100; margin-top: 4px; font-style: italic; font-weight: bold; border-top: 1px dotted #ccc; }
    </style>
</head>
<body>

<div class="container">
    <button id="btn-perm" class="btn-config" onclick="app.ativarNotificacoes()">‚öôÔ∏è ATIVAR NOTIFICA√á√ïES E SOM</button>

    <div id="painel-alarme">
        <div id="msg-alarme"></div>
        <button onclick="app.pararAlarme()" style="padding:12px; width:100%; border-radius:8px; border:none; font-weight:bold; margin-top:10px; cursor:pointer;">CONFERIDO</button>
    </div>

    <div class="nav-tabs">
        <button class="tab active" onclick="app.mudarAba('dia', this)">Janela do Dia</button>
        <button class="tab" onclick="app.mudarAba('semana', this)">Tabela Semana</button>
        <button class="tab" onclick="app.mudarAba('receitas', this)">Ingredientes</button>
        <button class="tab" onclick="app.mudarAba('compras', this)">Lista Compras</button>
    </div>
    <div id="app-view">A carregar dados...</div>
</div>

<script>
if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }

const app = {
    audioCtx: null, oscillator: null, loopSom: null, ultimoAlarme: null,
    base: {
        cafe: [
            { t: "P√£o com ovo", m: false, s: "" },
            { t: "Cuscuz com ovo", m: false, s: "" },
            { t: "Mingau de tapioca", m: true, s: "P√£o com Manteiga e Caf√©" },
            { t: "Mingau de milho", m: true, s: "P√£o com Queijo e Caf√©" },
            { t: "Aipim cozido", m: false, s: "" }
        ],
        bebidas: ["Caf√© puro", "Suco de Laranja", "Ch√°", "Suco de Abacaxi"],
        arroz: ["Arroz Branco", "Arroz Integral", "Arroz com Cenoura"],
        feijao: ["Feij√£o Carioca", "Feij√£o Preto", "Feij√£o Fradinho"],
        frangos: ["Frango Assado", "Frango Grelhado", "Frango Ensopado", "Strogonoff"],
        carnes: ["Carne mo√≠da", "Bife acebolado", "Alm√¥ndegas", "Iscas de carne"],
        acompa: ["Pur√©", "Salada", "Couve", "Farofa", "Creme de milho"],
        lanches: ["Banana", "Ma√ß√£", "Uva", "Melancia", "Iogurte", "Bolo", "P√£o de Queijo"],
        jantares: ["Sopa", "Omelete", "Canja", "Tapioca", "Caldo Verde"]
    },

    init() {
        if (!localStorage.getItem("plano_vFinal_Gold")) this.gerar();
        this.mudarAba('dia');
        setInterval(() => this.verificarRelogio(), 15000);
    },

    ativarNotificacoes() {
        Notification.requestPermission().then(p => { if(p === 'granted') alert('Notifica√ß√µes prontas!'); });
        if(!this.audioCtx) this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        document.getElementById('btn-perm').style.display = 'none';
    },

    gerar() {
        const dias = ["SEGUNDA","TER√áA","QUARTA","QUINTA","SEXTA","S√ÅBADO","DOMINGO"];
        let plano = {};
        const f1 = this.base.feijao[Math.floor(Math.random()*3)];
        const f2 = this.base.feijao[Math.floor(Math.random()*3)];
        dias.forEach((d, i) => {
            const c = this.base.cafe[i % 5];
            plano[d] = {
                cafe: c.t, isMingau: c.m, opcao2: c.s,
                bebida: c.m ? "" : this.base.bebidas[i % 4],
                lancheM: this.base.lanches[i % 7],
                arroz: this.base.arroz[i % 3],
                feijao: (i < 4) ? f1 : f2,
                proteina: (i % 2 === 0) ? this.base.frangos[i % 4] : this.base.carnes[i % 4],
                acompa: this.base.acompa[i % 5],
                lancheT: this.base.lanches[(i+3) % 7],
                jantar: this.base.jantares[i % 5]
            };
        });
        localStorage.setItem("plano_vFinal_Gold", JSON.stringify(plano));
    },

    verificarRelogio() {
        const agora = new Date();
        const hm = agora.getHours().toString().padStart(2, '0') + ":" + agora.getMinutes().toString().padStart(2, '0');
        if (["07:30", "13:00", "19:00", "21:00"].includes(hm) && this.ultimoAlarme !== hm) {
            this.ultimoAlarme = hm;
            this.dispararAlerta(hm);
        }
    },

    dispararAlerta(h) {
        document.getElementById("msg-alarme").innerHTML = `<h2>üîî ALERTA ${h}</h2><p>Hora de verificar as tarefas do card√°pio!</p>`;
        document.getElementById("painel-alarme").style.display = "block";
        if (Notification.permission === 'granted') { new Notification("Aviso de Hor√°rio", { body: `S√£o ${h}. Verifique o seu plano!` }); }
        this.tocarSom();
    },

    tocarSom() {
        if(!this.audioCtx) this.audioCtx = new AudioContext();
        const osc = this.audioCtx.createOscillator();
        const g = this.audioCtx.createGain();
        osc.connect(g); g.connect(this.audioCtx.destination);
        osc.start();
        this.loopSom = setInterval(() => {

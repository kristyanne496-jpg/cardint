<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Card√°pio Inteligente</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <style>
        :root { --primary: #4CAF50; --bg: #f4f4f9; --text: #333; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 15px; color: var(--text); }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .shopping-list { list-style: none; padding: 0; }
.shopping-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #f9f9f9;
    margin-bottom: 8px;
    padding: 12px;
    border-radius: 8px;
    transition: 0.3s;
}
.shopping-item.checked {
    background: #e8f5e9;
    opacity: 0.6;
    text-decoration: line-through;
}
.shopping-item input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
}
.btn-limpar {
    background: #f44336;
    font-size: 12px;
    padding: 8px;
    margin-bottom: 15px;
}
        .semana-dia-box {
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
    background: #fff;
}
.semana-dia-box h2 {
    background: var(--primary);
    color: white;
    padding: 5px 15px;
    border-radius: 5px;
    font-size: 1.1em;
}
.detalhe-refeicao {
    margin-bottom: 8px;
    padding-bottom: 5px;
    border-bottom: 1px dashed #eee;
}
.detalhe-refeicao strong {
    color: #555;
    font-size: 0.9em;
}
.detalhe-refeicao p {
    margin: 2px 0 0 0;
    font-size: 0.95em;
}
        
        /* Navega√ß√£o */
        .nav-tabs { display: flex; gap: 8px; margin-bottom: 20px; background: #eee; padding: 5px; border-radius: 10px; }
        .tab { flex: 1; padding: 12px; text-align: center; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; font-size: 14px; }
        .tab.active { background: var(--primary); color: white; }

        /* Blocos de Refei√ß√£o */
        .bloco { border-left: 5px solid var(--primary); background: #f9f9f9; padding: 12px; margin-bottom: 12px; border-radius: 5px; }
        .bloco h3 { margin: 0 0 5px 0; font-size: 0.85em; color: #666; text-transform: uppercase; }
        .bloco p { margin: 0; font-size: 1.05em; font-weight: 500; }

        /* Tarefas e Compras */
        .tarefa-alerta { background: #fff3cd; border: 1px solid #ffeeba; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9em; }
        .shopping-list { list-style: none; padding: 0; }
        .shopping-list li { padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
        
        button { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .footer-info { text-align: center; font-size: 0.8em; color: #999; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div id="app-nav" class="nav-tabs">
        <div class="tab active" onclick="app.mudarAba('dia')">Hoje</div>
        <div class="tab" onclick="app.mudarAba('semana')">Semana</div>
        <div class="tab" onclick="app.mudarAba('compras')">Compras</div>
    </div>

    <div id="conteudo-principal">
        </div>

    <div class="footer-info" id="status-plano"></div>
</div>

<script>
const app = {
    config: { feijaoDias: 4, proteinasRepetirMax: 2, totalSemanas: 12 },
    
    banco: {
        cafe: {
            bases: ["P√£o franc√™s","P√£o de forma","P√£o caseiro","Tapioca","Cuscuz","Bolo simples","Panqueca","Crepioca","P√£o de queijo","Torrada","Aipim cozido","Banana da terra cozida","Iogurte com frutas","Mingau de tapioca","Mingau de milho"],
            acompanhamentos: ["Manteiga","Requeij√£o","Queijo mussarela","Ovo mexido","Ovo cozido","Pat√™ de frango","Presunto","Peito de peru"],
            bebidas: ["Caf√©","Leite com achocolatado","Ch√°","Vitamina","Suco"]
                // Substitua as listas antigas por estas:
bebidaPadaria: ["Caf√© preto", "Leite com achocolatado", "Ch√°"], 
sucos: ["Maracuj√°", "Laranja", "Abacaxi", "Lim√£o", "Cupua√ßu", "Cacau", "Graviola", "Melancia"],
sobremesas: ["Gelatina", "Sorvete", "Pudim", "Mousse de maracuj√°", "Mousse de lim√£o"],
    
        },
        almoco: {
            feijoes: ["Feij√£o carioca","Feij√£o preto","Feij√£o fradinho"],
            proteinas: ["Frango cozido","Frango frito","Frango assado","Carne mo√≠da","Carne do sol","Carne de panela","Bife","Alm√¥ndega","Peixe frito","Moqueca","Ovo mexido","Panqueca de carne","Salsicha"],
            acompanhamentos: ["Macarr√£o","Pur√™","Batata cozida","Mandioca","Batata frita","Creme de milho","Farofa"],
            especial: "Feijoada Completa"
        },
        jantar: {
            opcoes: ["Arroz com ovo","Arroz com frango","Macarr√£o com frango","Sopa","Caldo de carne","Cachorro quente","Pizza","Hamb√∫rguer","Arroz doce"]
        },
        lanches: {
            frutas: ["Banana","Ma√ß√£","Uva","Abacaxi","Pera","Manga"],
            tarde: ["Biscoito","Iogurte","Bolo caseiro","Vitamina"]
        }
    },

    // --- L√ìGICA DE GERA√á√ÉO ---
    escolher(lista) { return lista[Math.floor(Math.random() * lista.length)]; },

    gerarPlanoCompleto() {
        let plano = [];
        for (let s = 0; s < this.config.totalSemanas; s++) {
            plano.push(this.gerarSemana());
        }
        localStorage.setItem("plano", JSON.stringify(plano));
        localStorage.setItem("diaAtual", "0");
        localStorage.setItem("ultimaVisita", new Date().toDateString());
    },

    gerarSemana() {
        const diasNome = ["Segunda","Ter√ßa","Quarta","Quinta","Sexta","S√°bado","Domingo"];
        let semana = {};
        let feijaoAtual = this.escolher(this.banco.almoco.feijoes);
        let protUltima = ""; let protCont = 0;

        diasNome.forEach((dia, index) => {
            // Localize onde o 'semana[d]' √© montado e use esta l√≥gica:
const baseCafe = this.escolher(this.banco.cafe);
const isMingau = baseCafe.toLowerCase().includes("mingau");
const prot = this.escolher(this.banco.proteina);

semana[d] = {
    cafe: {
        txt: isMingau ? baseCafe : `${baseCafe} com ${this.escolher(this.banco.acompa)}<br>‚Ä¢ ${this.escolher(this.banco.bebidaPadaria)}`,
        obs: isMingau ? "<span class='opcional'>Op√ß√£o 2: P√£o com Caf√©</span>" : ""
    },
    lancheM: this.escolher(this.banco.lanches),
    almoco: {
        txt: `Arroz e Feij√£o<br>‚Ä¢ ${prot}<br>‚Ä¢ ${this.escolher(this.banco.acompaAlmoco)}<br>‚Ä¢ Suco de ${this.escolher(this.banco.sucos)}`,
        obs: prot.includes("F√≠gado") ? "<span class='opcional'>Op√ß√£o 2: Frango Grelhado</span>" : "",
        sobremesa: (d === "S√ÅBADO" || d === "DOMINGO") ? `<span class='sobremesa'>üçÆ ${this.escolher(this.banco.sobremesas)}</span>` : ""
    },
    lancheT: `${this.escolher(["Biscoito", "Bolo", "Torradas"])} com ${this.escolher(["Ch√°", "Leite com achocolatado"])}`,
    jantar: `${this.escolher(this.banco.jantar)}<br>‚Ä¢ Suco de ${this.escolher(this.banco.sucos)}`
};
    
            // Troca feij√£o a cada 4 dias
            if (index === 4) feijaoAtual = this.escolher(this.banco.almoco.feijoes);

            // Regra de Prote√≠na
            let prot;
            do { prot = this.escolher(this.banco.almoco.proteinas); } 
            while (prot === protUltima && protCont >= this.config.proteinasRepetirMax - 1);
            
            protCont = (prot === protUltima) ? protCont + 1 : 0;
            protUltima = prot;

            // Feijoada no S√°bado (50% chance)
            let almocoFinal = { arroz: "Arroz", feijao: feijaoAtual, proteina: prot, acompanhamento: this.escolher(this.banco.almoco.acompanhamentos) };
            if (dia === "S√°bado" && Math.random() > 0.5) {
                almocoFinal.feijao = "Caldo de Feijoada";
                almocoFinal.proteina = this.banco.almoco.especial;
            }

            semana[dia] = {
                cafe: { base: this.escolher(this.banco.cafe.bases), acompanhamento: this.escolher(this.banco.cafe.acompanhamentos), bebida: this.escolher(this.banco.cafe.bebidas) },
                lancheManha: this.escolher(this.banco.lanches.frutas),
                almoco: almocoFinal,
                lancheTarde: this.escolher(this.banco.lanches.tarde),
                jantar: this.escolher(this.banco.jantar.opcoes)
            };
        });
        return semana;
    },

    // --- CONTROLE DE FLUXO ---
    iniciar() {
        if (!localStorage.getItem("plano")) this.gerarPlanoCompleto();
        this.verificarViradaDeDia();
        this.mudarAba('dia');
        this.agendarNotificacoes();
    },

    verificarViradaDeDia() {
        const hoje = new Date().toDateString();
        const ultima = localStorage.getItem("ultimaVisita");
        if (ultima !== hoje) {
            let dia = parseInt(localStorage.getItem("diaAtual"));
            dia++;
            if (dia >= (this.config.totalSemanas * 7)) {
                this.gerarPlanoCompleto();
            } else {
                localStorage.setItem("diaAtual", dia);
                localStorage.setItem("ultimaVisita", hoje);
            }
        }
    },

    obterDadosHoje() {
        const plano = JSON.parse(localStorage.getItem("plano"));
        const diaIdx = parseInt(localStorage.getItem("diaAtual"));
        const semIdx = Math.floor(diaIdx / 7);
        const diaSemanaIdx = diaIdx % 7;
        const diasChaves = Object.keys(plano[semIdx]);
        return { dados: plano[semIdx][diasChaves[diaSemanaIdx]], nome: diasChaves[diaSemanaIdx], diaGlobal: diaIdx };
    },

    // --- INTERFACE ---
    mudarAba(aba) {
        const abas = document.querySelectorAll('.tab');
        abas.forEach(t => t.classList.remove('active'));
        event?.target?.classList?.add('active') || abas[0].classList.add('active');

        const container = document.getElementById("conteudo-principal");
        const info = this.obterDadosHoje();
        
        if (aba === 'dia') {
            // Adicione esta linha logo antes do container.innerHTML:
const avisoPreparo = `
    <div class="aviso-fluxo">
        üì¢ <strong>Organiza√ß√£o:</strong> Prepare agora o lanche da tarde (${d.lancheT}) 
        e verifique os ingredientes do jantar.
    </div>`;

// E no innerHTML, chame a vari√°vel:
container.innerHTML = avisoPreparo + `... resto do seu c√≥digo ...`;


    renderDia(el, info) {
        const d = info.dados;
        let tarefasHtml = "";
        
        // L√≥gica de Tarefas Autom√°ticas
        if (d.almoco.feijao.includes("Feij√£o")) tarefasHtml += `<div class="tarefa-alerta">üîî <strong>Tarefa:</strong> Deixar feij√£o de molho agora para cozinhar.</div>`;
        if (d.cafe.base === "Cuscuz") tarefasHtml += `<div class="tarefa-alerta">ü•£ <strong>Tarefa:</strong> Hidratar o cuscuz 15min antes.</div>`;

        el.innerHTML = `
            <h2>${info.nome}-feira</h2>
            ${tarefasHtml}
            <div class="bloco"><h3>‚òï Caf√© da Manh√£</h3><p>${d.cafe.base} com ${d.cafe.acompanhamento} e ${d.cafe.bebida}</p></div>
            <div class="bloco"><h3>üçé Lanche</h3><p>${d.lancheManha}</p></div>
            <div class="bloco"><h3>üçõ Almo√ßo</h3><p>${d.almoco.arroz}, ${d.almoco.feijao}, ${d.almoco.proteina} e ${d.almoco.acompanhamento}</p></div>
            <div class="bloco"><h3>üç™ Tarde</h3><p>${d.lancheTarde}</p></div>
            <div class="bloco"><h3>üåô Jantar</h3><p>${d.jantar}</p></div>
            <button onclick="app.concluirDiaManual()">Concluir Dia e Avan√ßar</button>
        `;
    },

        renderSemana(el) {
        const plano = JSON.parse(localStorage.getItem("plano"));
        const diaIdx = parseInt(localStorage.getItem("diaAtual"));
        const semIdx = Math.floor(diaIdx / 7);
        const semana = plano[semIdx];
        
        let html = `<h1>Detalhes da Semana</h1>`;
        
        Object.entries(semana).forEach(([dia, d]) => {
            html += `
                <div class="semana-dia-box">
                    <h2>${dia}-feira</h2>
                    
                    <div class="detalhe-refeicao">
                        <strong>‚òï Caf√© da Manh√£:</strong>
                        <p>${d.cafe.base} com ${d.cafe.acompanhamento} (${d.cafe.bebida})</p>
                    </div>

                    <div class="detalhe-refeicao">
                        <strong>üçé Lanche da Manh√£:</strong>
                        <p>${d.lancheManha}</p>
                    </div>

                    <div class="detalhe-refeicao">
                        <strong>üçõ Almo√ßo:</strong>
                        <p>${d.almoco.arroz}, ${d.almoco.feijao}, ${d.almoco.proteina} e ${d.almoco.acompanhamento}</p>
                    </div>

                    <div class="detalhe-refeicao">
                        <strong>üç™ Lanche da Tarde:</strong>
                        <p>${d.lancheTarde}</p>
                    </div>

                    <div class="detalhe-refeicao">
                        <strong>üåô Jantar:</strong>
                        <p>${d.jantar}</p>
                    </div>
                </div>
            `;
        });
        
        el.innerHTML = html;
        window.scrollTo(0,0); // Volta para o topo ao abrir
    },


        renderCompras(el) {
        const { semana } = this.obterDados();
        const itensSet = new Set();
        
        // Coleta todos os itens base da semana
        Object.values(semana).forEach(d => {
            // Extrai as palavras principais para a lista
            const extrator = (str) => str.split('<br>')[0].split(' com ')[0].replace('‚Ä¢ ', '');
            itensSet.add(extrator(d.cafe));
            itensSet.add(d.lancheM);
            itensSet.add("Arroz branco");
            itensSet.add(extrator(d.almoco.split('<br>‚Ä¢ ')[1])); // Feij√£o
            itensSet.add(extrator(d.almoco.split('<br>‚Ä¢ ')[2])); // Prote√≠na
        });

        const estoque = JSON.parse(localStorage.getItem("estoque") || "[]");
        
        let html = `<h2>üõí Estoque e Compras</h2>
                    <p style="font-size:0.8em; color:#666">Marque o que voc√™ j√° tem em casa:</p>
                    <button class="btn-limpar" onclick="app.limparEstoque()">Limpar Sele√ß√£o</button>
                    <ul class="shopping-list">`;

        Array.from(itensSet).sort().forEach(item => {
            const isChecked = estoque.includes(item) ? "checked" : "";
            const isCheckedAttr = estoque.includes(item) ? "checked" : "";
            
            html += `
                <li class="shopping-item ${isChecked}">
                    <span>${item}</span>
                    <input type="checkbox" ${isCheckedAttr} onchange="app.toggleEstoque('${item}')">
                </li>`;
        });

        el.innerHTML = html + `</ul>`;
    },

    toggleEstoque(item) {
        let estoque = JSON.parse(localStorage.getItem("estoque") || "[]");
        if (estoque.includes(item)) {
            estoque = estoque.filter(i => i !== item);
        } else {
            estoque.push(item);
        }
        localStorage.setItem("estoque", JSON.stringify(estoque));
        this.mudarAba('compras'); // Recarrega a tela para aplicar o estilo visual
    },

    limparEstoque() {
        if(confirm("Deseja desmarcar todos os itens?")) {
            localStorage.setItem("estoque", "[]");
            this.mudarAba('compras');
        }
    }

    concluirDiaManual() {
        if(confirm("Deseja avan√ßar para o card√°pio de amanh√£?")) {
            localStorage.setItem("ultimaVisita", "for√ßar_update");
            this.verificarViradaDeDia();
            this.mudarAba('dia');
        }
    },

    // --- NOTIFICA√á√ïES ---
    agendarNotificacoes() {
        if (!("Notification" in window)) return;
        Notification.requestPermission();
        
        const info = this.obterDadosHoje().dados;
        const agendamentos = [
            { h: 7, m: 0, t: "Caf√© da Manh√£", c: info.cafe.base },
            { h: 12, m: 0, t: "Almo√ßo", c: info.almoco.proteina },
            { h: 18, m: 30, t: "Jantar", c: info.jantar }
        ];

        agendamentos.forEach(a => {
            const agora = new Date();
            const alvo = new Date();
            alvo.setHours(a.h, a.m, 0);
            if (alvo > agora) {
                setTimeout(() => {
                    new Notification(a.t, { body: `Hoje teremos: ${a.c}` });
                }, alvo - agora);
            }
        });
    }
};

// Registro de Service Worker para PWA
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(() => console.log("SW offline mode ready"));
}

app.iniciar();
</script>
</body>
</html>
